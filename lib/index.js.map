{"version":3,"sources":["../src/index.js"],"names":["run","fileCopySync","src","dest","mkdirsSync","dirname","writeFileSync","readFileSync","relative","process","cwd","getCliPath","binPath","mainModule","filename","indexOf","resolve","getBabelPath","getKoahubPath","getRuntimeFile","file","appName","runtimeName","replace","walk","dir","exist","existsSync","files","readdirSync","list","statSync","isDirectory","concat","push","mode","mkdirSync","compileByBabel","runtimeFile","checkFileExtensions","basename","content","babel","require","data","transform","presets","plugins","code","extensions","regExp","validate","key","RegExp","test","checkFilesChange","changedFiles","mTimeApp","mtime","getTime","mTimeRuntime","version","command","description","option","action","script","options","rootPath","app","appPath","appFile","runtime","runtimePath","cliPath","watch","startRuntimeProcess","runtimeProcess","fork","on","signal","connected","exit","stopRuntimeProcess","kill","compile","err","time","Date","filePath","newTime","timeOut","setTimeout","length","clearTimeout","destFile","normalize","srcFile","parse","argv","args","help","argvs","argvt","split"],"mappings":"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","file":"index.js","sourcesContent":["import fs from \"fs\";\nimport path from \"path\";\nimport child_process from \"child_process\";\nimport program from \"commander\";\nimport watch from \"./util/watch.util\";\nimport log, {debug} from \"./util/log.util\";\nimport config from \"./config/default.config\";\nimport packageFile from \"./../package.json\";\n\nfunction fileCopySync(src, dest) {\n    mkdirsSync(path.dirname(dest));\n    fs.writeFileSync(dest, fs.readFileSync(src));\n    log(`[File] ${path.relative(process.cwd(), src)}`);\n}\n\nfunction getCliPath() {\n\n    let binPath;\n    if (process.mainModule.filename.indexOf('koahub-cli') != -1) {\n        binPath = path.resolve(process.mainModule.filename, '../../');\n    } else {\n        binPath = path.resolve(process.cwd(), 'node_modules/koahub-cli');\n    }\n\n    return binPath;\n}\n\nfunction getBabelPath() {\n    return path.resolve('node_modules/.bin/babel');\n}\n\nfunction getKoahubPath() {\n    return path.resolve('node_modules/.bin/koahub');\n}\n\nfunction getRuntimeFile(file, appName, runtimeName) {\n    return file.replace(`${appName}`, `${runtimeName}`);\n}\n\nfunction walk(dir) {\n\n    const exist = fs.existsSync(dir);\n    if (!exist) {\n        return;\n    }\n\n    const files = fs.readdirSync(dir);\n    let list = [];\n\n    for (let file of files) {\n        if (fs.statSync(path.resolve(dir, file)).isDirectory()) {\n            list = list.concat(walk(path.resolve(dir, file)));\n        } else {\n            list.push(path.resolve(dir, file));\n        }\n    }\n\n    return list;\n}\n\nfunction mkdirsSync(dirname, mode) {\n\n    if (fs.existsSync(dirname)) {\n        return true;\n    } else {\n        if (mkdirsSync(path.dirname(dirname), mode)) {\n            fs.mkdirSync(dirname, mode);\n            return true;\n        }\n    }\n}\n\nfunction compileByBabel(file, appName, runtimeName) {\n\n    let runtimeFile = getRuntimeFile(file, appName, runtimeName);\n    if (!checkFileExtensions(file)) {\n        if (path.basename(file) != '.DS_Store') {\n            fileCopySync(file, runtimeFile);\n        }\n        return;\n    }\n\n    mkdirsSync(path.dirname(runtimeFile));\n\n    let content = fs.readFileSync(file);\n    let babel = require('babel-core');\n    let data = babel.transform(content, {\n        filename: file,\n        presets: ['es2015', 'stage-3'],\n        plugins: ['transform-runtime']\n    });\n\n    fs.writeFileSync(`${runtimeFile}`, data.code);\n\n    log(`[Babel] ${path.relative(process.cwd(), file)}`);\n}\n\nfunction checkFileExtensions(file) {\n\n    const extensions = ['.js', '.jsx', '.es6', '.es'];\n    let regExp, validate = false;\n    for (let key in extensions) {\n        regExp = new RegExp(`${extensions[key]}$`);\n        if (regExp.test(file)) {\n            validate = true;\n        }\n    }\n    return validate;\n}\n\nfunction checkFilesChange(appName, runtimeName) {\n\n    let changedFiles = [];\n    let files = walk(appName);\n\n    for (let key in files) {\n        let mTimeApp = fs.statSync(files[key]).mtime.getTime();\n        let runtimeFile = getRuntimeFile(files[key], appName, runtimeName);\n\n        if (fs.existsSync(runtimeFile)) {\n            let mTimeRuntime = fs.statSync(runtimeFile).mtime.getTime();\n            if (mTimeRuntime < mTimeApp) {\n                changedFiles.push(files[key]);\n            }\n        } else {\n            changedFiles.push(files[key]);\n        }\n    }\n\n    return changedFiles;\n}\n\n\nprogram\n    .version(packageFile.version)\n\nprogram\n    .command('start [script]')\n    .description('koahub start script --watch --compile')\n    .option('-w, --watch', 'auto restart when a file is modified')\n    .option('-c, --compile', 'auto babel process when a file is modified')\n    .option('-r, --runtime [dir]', 'Babel compile and start the dir')\n    .action(function (script, options) {\n\n        const rootPath = process.cwd();\n        const appName = path.dirname(script) || config.app;\n        const appPath = path.resolve(rootPath, appName);\n        const appFile = path.resolve(rootPath, script);\n        const runtimeName = options.runtime || config.runtime;\n        const runtimePath = path.resolve(rootPath, runtimeName);\n        const runtimeFile = path.resolve(rootPath, getRuntimeFile(script, appName, runtimeName));\n\n        const cliPath = getCliPath();\n\n        // 监控启动\n        if (options.watch) {\n\n            // 编译并且监控启动\n            if (options.compile) {\n                const changedFiles = checkFilesChange(appName, runtimeName);\n                for (let key in changedFiles) {\n                    compileByBabel(changedFiles[key], appName, runtimeName);\n                }\n            }\n\n            let runtimeProcess;\n\n            function startRuntimeProcess(runtimeFile) {\n                runtimeProcess = child_process.fork(runtimeFile);\n                runtimeProcess.on('exit', function (code, signal) {\n                    if (runtimeProcess.connected == false) {\n                        process.exit();\n                    }\n                });\n            }\n\n            function stopRuntimeProcess() {\n                if (runtimeProcess) runtimeProcess.kill();\n            }\n\n            // 启动运行时进程\n            startRuntimeProcess(runtimeFile);\n\n            // 捕获SIGTERM退出信号\n            process.on('SIGTERM', function () {\n                stopRuntimeProcess();\n                process.exit();\n            });\n\n            // 捕获未知错误\n            process.on('uncaughtException', function (err) {\n                debug(err);\n            });\n\n            let time = new Date();\n            let files = [];\n            // 开启文件监控\n            watch(appName, runtimeName, function (filePath, compile = true) {\n\n                if (options.compile == true && compile == true) {\n                    files.push(filePath);\n                }\n\n                let newTime = new Date();\n                let timeOut = setTimeout(function () {\n                    if (files.length) {\n                        for (let key in files) {\n                            compileByBabel(files[key], appName, runtimeName);\n                        }\n                        // 未编译文件清空\n                        files = [];\n                    }\n                    // 进程退出\n                    stopRuntimeProcess();\n                    // 进程启动\n                    startRuntimeProcess(runtimeFile);\n                }, 100);\n\n                if (newTime - time <= 100) {\n                    clearTimeout(timeOut);\n                }\n\n                time = newTime;\n            });\n\n            return;\n        }\n\n        // 直接编译启动\n        if (options.compile) {\n            const changedFiles = checkFilesChange(appName, runtimeName);\n            for (let key in changedFiles) {\n                compileByBabel(changedFiles[key], appName, runtimeName);\n            }\n        }\n\n        // 直接启动, 无法require启动\n        child_process.fork(runtimeFile);\n    });\n\nprogram\n    .command('controller [file]')\n    .description('koahub create controller')\n    .action(function (file) {\n\n        const destFile = path.normalize(`${file}.controller.js`);\n        const srcFile = path.resolve(getCliPath(), 'template/controller/index.controller.js');\n\n        fileCopySync(srcFile, destFile);\n    });\n\n// mainMoule路径中含有koahub-cli为命令行启动\nif (process.mainModule.filename.indexOf('koahub-cli') != -1) {\n    program.parse(process.argv);\n    if (!program.args.length) program.help();\n}\n\n// 支持导入koahub-cli启动\nexport function run(argv) {\n\n    if (!argv) {\n        program.help();\n        return;\n    }\n\n    let argvs = [];\n    argvs.push(process.argv[0]);\n    argvs.push(getKoahubPath());\n\n    if (argv.indexOf(' ') != -1) {\n        const argvt = argv.split(' ');\n        for (let key in argvt) {\n            argvs.push(argvt[key]);\n        }\n    } else {\n        argvs.push(argv);\n    }\n\n    program.parse(argvs);\n}\n"]}